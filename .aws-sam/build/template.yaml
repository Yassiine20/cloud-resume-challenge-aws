AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Cloud Resume Challenge - Backend Infrastructure
Globals:
  Function:
    Timeout: 10
    Runtime: python3.11
    Environment:
      Variables:
        TABLE_NAME:
          Ref: VisitorCountTable
Resources:
  VisitorCountTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: cloud-resume-visitors
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  VisitorCounterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: VisitorCounter
      CodeUri: VisitorCounterFunction
      Handler: lambda_function.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: VisitorCountTable
      Events:
        VisitorCountApi:
          Type: Api
          Properties:
            Path: /count
            Method: post
            RestApiId:
              Ref: VisitorCountApi
    Metadata:
      SamResourceId: VisitorCounterFunction
  VisitorCountApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowOrigin: '''https://yassineresume.dev'''
        AllowHeaders: '''Content-Type'''
        AllowMethods: '''POST,OPTIONS'''
Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${VisitorCountApi}.execute-api.${AWS::Region}.amazonaws.com/prod/count
  FunctionName:
    Description: Lambda Function Name
    Value:
      Ref: VisitorCounterFunction
  TableName:
    Description: DynamoDB Table Name
    Value:
      Ref: VisitorCountTable
